{% extends "base.html" %}

{% block title %}Назначить преподавателей{% endblock %}

{% block content %}
<h1>Назначить преподавателей</h1>
<div style="display: flex;">
    <div style="width: 50%; padding: 20px; background-color: #f0f8ff;">
        <h2>Специальности и Профессии</h2>
        {% for item in items %}
        <div class="item {% if item[2] %}specialty{% else %}profession{% endif %}" data-id="{{ item[0] }}">
            {% if item[3] %}
            <details open>
                <summary>{{ item[1] }} ({{ item[3].split(',') | length }})</summary>
                <div class="worker-list">
                    {% for worker_fio in item[3].split(',') %}
                        <div class="assigned-worker">
                            {{ worker_fio }}
                            <button class="unassign-button" data-worker-fio="{{ worker_fio }}" data-item-id="{{ item[0] }}">-</button>
                        </div>
                    {% endfor %}
                </div>
            </details>
            {% else %}
            <details>
                <summary>{{ item[1] }} (0)</summary>
                <div class="worker-list">
                    <p>Нет назначенных преподавателей</p>
                </div>
            </details>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    <div style="width: 50%; padding: 20px; background-color: #e6ffe6;">
        <h2>Преподаватели</h2>
        {% for worker in workers %}
        <div class="worker" draggable="true" data-id="{{ worker[0] }}">
            {{ worker[1] }}
        </div>
        {% endfor %}
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const workers = document.querySelectorAll('.worker');
        const items = document.querySelectorAll('.item');
        const unassignButtons = document.querySelectorAll('.unassign-button');

        workers.forEach(worker => {
            worker.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', worker.dataset.id);
            });
        });

        items.forEach(item => {
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                const workerId = e.dataTransfer.getData('text/plain');
                const itemId = item.dataset.id;

                fetch('/add_worker_to_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ worker_id: workerId, item_id: itemId }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Преподаватель добавлен');
                        window.location.reload();  // Refresh the page
                    } else if (data.status === 'already_assigned') {
                        alert('Преподаватель уже назначен');
                    }
                });
            });
        });

        unassignButtons.forEach(button => {
            button.addEventListener('click', function() {
                const workerFio = this.dataset.workerFio;
                const itemId = this.dataset.itemId;

                fetch('/remove_worker_from_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ worker_fio: workerFio, item_id: itemId }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Преподаватель удален');
                        window.location.reload();  // Refresh the page
                    } else if (data.status === 'worker_not_found') {
                        alert('Преподаватель не найден');
                    }
                });
            });
        });
    });
</script>
{% endblock %}
