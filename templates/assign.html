{% extends "base.html" %}

{% block title %}Назначить преподавателей{% endblock %}

{% block content %}
<h1>Назначить преподавателей</h1>
<div style="display: flex;">
    <div class="scrollable">
        <h2>Специальности и Профессии</h2>
        {% for item in items %}
        <div class="item-{% if item[2] %}specialty{% else %}profession{% endif %}" data-id="{{ item[0] }}">
            <details>
                <summary style="list-style:none; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                    <span>{{ item[1] }} ({% if item[3] %}{{ item[3].split(',')|length }}{% else %}0{% endif %})</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-down-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </summary>
                <div class="worker-list">
                    {% if item[3] %}
                        {% for worker_fio in item[3].split(',') %}
                            <div class="assigned-worker">
                                {{ worker_fio }}
                                <button class="unassign-button" data-worker-fio="{{ worker_fio }}" data-item-id="{{ item[0] }}">✖</button>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>Нет назначенных преподавателей</p>
                    {% endif %}
                </div>
            </details>
        </div>
        {% endfor %}
    </div>
    <div class="scrollable">
        <h2>Преподаватели</h2>
        <input type="text" id="searchInput" placeholder="Поиск по ФИО..." title="Введите ФИО" 
        style="padding: 10px; margin-bottom: 10px;">

        <div id="workersContainer">
            {% for worker in workers %}
            <div class="worker" draggable="true" data-id="{{ worker[0] }}">
                ⋮ {{ worker[1] }}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        searchInput.focus();
        const workersContainer = document.getElementById('workersContainer');
        const workers = document.querySelectorAll('.worker');
        const items = document.querySelectorAll('.item');
        const unassignButtons = document.querySelectorAll('.unassign-button');

        // Search functionality
        searchInput.addEventListener('input', function() {
            const searchTerm = searchInput.value.toLowerCase();

            workers.forEach(worker => {
                const fio = worker.textContent.toLowerCase();
                if (fio.includes(searchTerm)) {  // Use includes instead of startsWith for more flexible search
                    worker.style.display = 'inline-grid';
                } else {
                    worker.style.display = 'none';
                }
            });
        });

        // Drag and drop functionality
        workers.forEach(worker => {
            worker.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', worker.dataset.id);
            });
        });

        items.forEach(item => {
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                const workerId = e.dataTransfer.getData('text/plain');
                const itemId = item.dataset.id;

                fetch('/add_worker_to_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ worker_id: workerId, item_id: itemId }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Преподаватель добавлен');
                        window.location.reload();  // Refresh the page
                    } else if (data.status === 'already_assigned') {
                        alert('Преподаватель уже назначен');
                    }
                });
            });
        });

        unassignButtons.forEach(button => {
            button.addEventListener('click', function() {
                const workerFio = this.dataset.workerFio;
                const itemId = this.dataset.itemId;

                fetch('/remove_worker_from_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ worker_fio: workerFio, item_id: itemId }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Преподаватель удален');
                        window.location.reload();  // Refresh the page
                    } else if (data.status === 'worker_not_found') {
                        alert('Преподаватель не найден');
                    }
                });
            });
        });

        const scrollableBlocks = document.querySelectorAll('.scrollable');

        // Функция проверки положения прокрутки
        function handleGradient(block) {
            const scrollHeight = block.scrollHeight;
            const clientHeight = block.clientHeight;
            const scrollTop = block.scrollTop;

            // Проверяем, достигнута ли нижняя точка
            if ((scrollTop + clientHeight) >= scrollHeight) {
                block.classList.add('no-gradient'); // Убираем градиент
            } else {
                block.classList.remove('no-gradient'); // Возвращаем градиент обратно
            }
        }

        // Назначаем обработчик события прокрутки каждому блоку
        scrollableBlocks.forEach((block) => {
            block.addEventListener('scroll', () => handleGradient(block));
        });
    });
</script>
{% endblock %}
